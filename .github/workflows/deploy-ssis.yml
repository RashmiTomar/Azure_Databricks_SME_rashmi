name: Deploy SSIS ISPACs (Manual)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug - list ISPAC files
        shell: pwsh
        run: |
          Write-Host "ISPAC files found:"
          Get-ChildItem -Path artifacts/ispacs -Filter *.ispac | Select Name

      - name: Debug - show packages.json
        shell: pwsh
        run: |
          Write-Host "packages.json content:"
          Get-Content deploy/packages.json

      - name: Test Azure SQL connection
        shell: pwsh
        env:
          SQLSERVER: ${{ secrets.SSISDB_SQLSERVER }}
          SQLUSER: ${{ secrets.SSISDB_SQLUSER }}
          SQLPASSWORD: ${{ secrets.SSISDB_SQLPASSWORD }}
        run: |
          $env:SQLCMDPASSWORD = $env:SQLPASSWORD
          sqlcmd -S $env:SQLSERVER -d SSISDB -U $env:SQLUSER -C -b -Q "SELECT name FROM catalog.folders;"

      - name: Deploy ISPACs to SSISDB
        shell: pwsh
        env:
          SQLSERVER: ${{ secrets.SSISDB_SQLSERVER }}
          SQLUSER: ${{ secrets.SSISDB_SQLUSER }}
          SQLPASSWORD: ${{ secrets.SSISDB_SQLPASSWORD }}
        run: |
          ./deploy/deploy-ispac.ps1 `
            -SqlServer $env:SQLSERVER `
            -SqlUser $env:SQLUSER `
            -SqlPassword $env:SQLPASSWORD `
            -PackagesJsonPath "./deploy/packages.json"
